- Rebuild the code using a vector of segments
- Add assert for some functions
